#!/usr/bin/env bash

# ============================================================================
# Dotfiles Health Check
# Verifies installation and configuration of all tools
# ============================================================================

GREEN='\033[0;32m'
YELLOW='\033[1;33m'
RED='\033[0;31m'
BLUE='\033[0;34m'
NC='\033[0m'

echo -e "${BLUE}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
echo -e "${BLUE}ğŸ¥ Dotfiles Health Check${NC}"
echo -e "${BLUE}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
echo ""

# Counter
TOTAL=0
PASSED=0
WARNINGS=0
FAILED=0

check_command() {
  local cmd=$1
  local name=$2
  TOTAL=$((TOTAL + 1))
  
  if command -v $cmd &> /dev/null; then
    echo -e "${GREEN}âœ“${NC} $name"
    PASSED=$((PASSED + 1))
  else
    echo -e "${RED}âœ—${NC} $name ${YELLOW}(not installed)${NC}"
    FAILED=$((FAILED + 1))
  fi
}

check_file() {
  local file=$1
  local name=$2
  TOTAL=$((TOTAL + 1))
  
  if [[ -f "$file" ]]; then
    echo -e "${GREEN}âœ“${NC} $name"
    PASSED=$((PASSED + 1))
  else
    echo -e "${RED}âœ—${NC} $name ${YELLOW}(missing)${NC}"
    FAILED=$((FAILED + 1))
  fi
}

check_symlink() {
  local link=$1
  local name=$2
  TOTAL=$((TOTAL + 1))
  
  if [[ -L "$link" ]]; then
    echo -e "${GREEN}âœ“${NC} $name"
    PASSED=$((PASSED + 1))
  else
    echo -e "${YELLOW}âš ${NC} $name ${YELLOW}(not a symlink)${NC}"
    WARNINGS=$((WARNINGS + 1))
  fi
}

# Check CLI Tools
echo -e "${BLUE}ğŸ“¦ CLI Tools${NC}"
check_command "zsh" "Zsh"
check_command "git" "Git"
check_command "fzf" "FZF"
check_command "bat" "Bat"
check_command "lsd" "LSD"
check_command "zoxide" "Zoxide"
check_command "starship" "Starship"
check_command "fnm" "FNM"
check_command "delta" "Git Delta"
check_command "lazygit" "Lazygit"
check_command "direnv" "Direnv"
check_command "ollama" "Ollama"
echo ""

# Check Config Files
echo -e "${BLUE}ğŸ“ Configuration Files${NC}"
check_file "$HOME/.dotfiles/terminal/zsh/zshrc" "zshrc"
check_file "$HOME/.dotfiles/git/gitconfig" "gitconfig"
check_file "$HOME/.dotfiles/vscode/settings.json" "VS Code settings"
check_file "$HOME/.dotfiles/terminal/starship/starship.toml" "Starship config"
echo ""

# Check Symlinks
echo -e "${BLUE}ğŸ”— Symlinks${NC}"
check_symlink "$HOME/.zshrc" "~/.zshrc"
check_symlink "$HOME/.config/starship.toml" "~/.config/starship.toml"
check_symlink "$HOME/.config/Code/User/settings.json" "VS Code settings"
check_symlink "$HOME/.config/Cursor/User/settings.json" "Cursor settings"
echo ""

# Check Zinit
echo -e "${BLUE}ğŸ”Œ Zinit Plugins${NC}"
TOTAL=$((TOTAL + 1))
if [[ -d "${HOME}/.local/share/zinit/zinit.git" ]]; then
  echo -e "${GREEN}âœ“${NC} Zinit installed"
  PASSED=$((PASSED + 1))
  
  # Count plugins
  plugin_count=$(ls -1 "${HOME}/.local/share/zinit/plugins" 2>/dev/null | wc -l)
  echo -e "  ${BLUE}â†’${NC} $plugin_count plugins installed"
else
  echo -e "${RED}âœ—${NC} Zinit ${YELLOW}(not installed)${NC}"
  FAILED=$((FAILED + 1))
fi
echo ""

# Summary
echo -e "${BLUE}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
echo -e "${BLUE}ğŸ“Š Summary${NC}"
echo -e "${BLUE}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
echo -e "Total checks: $TOTAL"
echo -e "${GREEN}Passed: $PASSED${NC}"
[[ $WARNINGS -gt 0 ]] && echo -e "${YELLOW}Warnings: $WARNINGS${NC}"
[[ $FAILED -gt 0 ]] && echo -e "${RED}Failed: $FAILED${NC}"
echo ""

# Health score
SCORE=$((PASSED * 100 / TOTAL))
if [[ $SCORE -ge 90 ]]; then
  echo -e "${GREEN}ğŸ‰ Health Score: $SCORE% - Excellent!${NC}"
elif [[ $SCORE -ge 70 ]]; then
  echo -e "${YELLOW}ğŸ‘ Health Score: $SCORE% - Good${NC}"
else
  echo -e "${RED}âš ï¸  Health Score: $SCORE% - Needs attention${NC}"
fi
echo ""

exit 0
