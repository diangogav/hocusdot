#!/usr/bin/env bash

# Check dependencies
for cmd in fzf bat lsd; do
  if ! command -v $cmd &> /dev/null; then
    echo "âŒ Error: $cmd is required but not installed."
    exit 1
  fi
done

# Function to get script description from first comment
get_description() {
  local file="$1"
  if [[ -f "$file" && -x "$file" ]]; then
    # Get first comment line (after shebang)
    grep -m 1 "^#[^!]" "$file" 2>/dev/null | sed 's/^# *//' || echo ""
  fi
}

# Function to browse directories
browse() {
  local dir="$1"
  local breadcrumb="${dir#${DOTFILES_PATH:-$HOME/.dotfiles}/scripts}"
  breadcrumb="${breadcrumb:-/}"
  
  # Find items and sort: directories first, then files
  find "$dir" -mindepth 1 -maxdepth 1 | sort -t/ -k1 | \
  awk -v dir="$dir" '
    BEGIN { dirs=""; files="" }
    {
      if (system("test -d \"" $0 "\"") == 0) {
        dirs = dirs $0 "\n"
      } else {
        files = files $0 "\n"
      }
    }
    END { printf "%s%s", dirs, files }
  ' | grep -v "^$" | \
  fzf \
    --prompt="ğŸ“‚ $breadcrumb > " \
    --header="Navigate: Enter to select | Esc to cancel | Ctrl-C to exit" \
    --preview='
      if [ -d {} ]; then
        echo "ğŸ“ Directory: $(basename {})"
        echo ""
        lsd --tree --depth 2 --classify {}
      else
        echo "ğŸ“œ Script: $(basename {})"
        desc=$(grep -m 1 "^#[^!]" {} 2>/dev/null | sed "s/^# *//")
        [[ -n "$desc" ]] && echo "â„¹ï¸  $desc"
        echo ""
        bat --color=always --style=numbers --line-range=:30 {}
      fi
    ' \
    --preview-window=right:60% \
    --height=90% \
    --layout=reverse \
    --border=rounded \
    --color="header:italic:cyan,prompt:bold:blue"
}

# Main loop
SCRIPTS_DIR="${DOTFILES_PATH:-$HOME/.dotfiles}/scripts"
current_path="$SCRIPTS_DIR"
selected=$(browse "$current_path")

while [[ -d "$selected" ]]; do
  current_path="$selected"
  selected=$(browse "$current_path")
done

if [[ -n "$selected" && -f "$selected" ]]; then
  echo ""
  echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
  echo "ğŸš€ Running: $(basename "$selected")"
  desc=$(get_description "$selected")
  [[ -n "$desc" ]] && echo "â„¹ï¸  $desc"
  echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
  echo ""
  "$selected" "$@"
fi